name: Release bundle

on:
  push:
    tags:
      - '*'


jobs:
  create-bundle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: download ansible-bundler
        uses: robinraju/release-downloader@v1
        id: download
        with:
          # switch to upstream repository when merged https://github.com/kriansa/ansible-bundler/pull/16
          repository: 'mhitza/ansible-bundler'
          fileName: '*_amd64.deb'
          out-file-path: '/tmp'
          latest: true
      - name: install ansible-bundler
        run: sudo dpkg -i ${{ fromJson(steps.download.outputs.downloaded_files)[0] }}

      - name: package repo-ansible.run
        run: >
          bundle-playbook -f playbook-cwd.yaml
          --extra-deps=tasks --extra-deps=templates --extra-deps=library
          --extra-deps=repo.schema.yaml
          --python-package=jsonschema
          -o repo-ansible.run

      - uses: actions/upload-artifact@v4
        with:
          path: repo-ansible.run
          retention-days: 1

  test-bundle:
    needs: [ create-bundle ]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - run: python --version
      - name: quick binary test run on this repo - ${{ matrix.os }}
        run: chmod +x ./artifact/repo-ansible.run && ./artifact/repo-ansible.run
        env:
          ANSIBLE_DISPLAY_OK_HOSTS: 0
          ANSIBLE_DISPLAY_SKIPPED_HOSTS: 0

  create-release:
    runs-on: ubuntu-latest
    needs: [ test-bundle ]
    steps:
      - uses: actions/download-artifact@v4
      - uses: softprops/action-gh-release@v2
        with:
          files: artifact/repo-ansible.run
          generate_release_notes: true
          make_latest: true
